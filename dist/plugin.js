"use strict";function _extends(){return _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},_extends.apply(this,arguments)}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}W.loadPlugin({name:"windy-plugin-sounding",version:"0.5.2",author:"Victor Berchet",repository:{type:"git",url:"git+https://github.com/vicb/windy-plugin-sounding"},description:"Soundings for paraglider pilots.",displayName:"Better Sounding",hook:"contextmenu",dependencies:["https://cdn.jsdelivr.net/npm/d3@5/dist/d3.min.js","https://cdn.jsdelivr.net/npm/preact@8/dist/preact.min.js"],className:"plugin-lhpane plugin-mobile-fullscreen",exclusive:"lhpane"},"<div class=\"plugin-content\"> <div class=\"title\">Sounding forecast <span id=\"sounding-model\"></span></div> <div id=\"sounding-chart\"></div> </div>",".onwindy-plugin-sounding .left-border{left:600px}.onwindy-plugin-sounding #search{display:none}#windy-plugin-sounding{font-size:12px;padding:1em 1em;line-height:2;z-index:100;width:600px}#windy-plugin-sounding .title{margin:0 0 .3em .6em;font-size:16px}#windy-plugin-sounding .closing-x{display:block}@media only screen and (max-device-width:736px){#windy-plugin-sounding{display:block;left:0;top:0;right:0;width:calc(100% - 20px);margin:10px}}#windy-plugin-sounding .axis path,#windy-plugin-sounding .axis line{fill:none;stroke:#000;shape-rendering:crispEdges}#windy-plugin-sounding #sounding-chart svg{width:100%;height:600px}#windy-plugin-sounding #sounding-chart .infoline{stroke-width:1.5;fill:none;stroke-linejoin:round;stroke-linecap:round}#windy-plugin-sounding #sounding-chart .infoline.dewpoint{stroke:steelblue}#windy-plugin-sounding #sounding-chart .infoline.temperature{stroke:red}#windy-plugin-sounding #sounding-chart .infoline.wind{stroke:purple}#windy-plugin-sounding #sounding-chart .surface{fill:brown;opacity:.2}#windy-plugin-sounding #fly-to{padding:0 15px 0 8px}#windy-plugin-sounding #fly-to .location{border:1px solid #bbb;border-radius:1em;line-height:1em;padding:.3em .6em;user-select:none;display:inline-block;margin-right:.3em;cursor:pointer}#windy-plugin-sounding #fly-to .selected{background-color:#d49500;border-color:#d49500;color:white}",function(){var a,b=this,d=W.require("windy-plugin-sounding/soundingGraph"),e=W.require("plugins"),f=W.require("store"),g=W.require("pluginDataLoader"),h=W.require("map"),i=g({key:"QKlmnpLWr2rZSyFaT7LpxZc0d5bo34D4",plugin:"windy-plugin-sounding"}),j=null,k=e["detail-render"].load().then(function(){return W.define("sMeteogram",["meteogram","Class"],function(a,b){var c=this;return b.extend(a,{legend:function a(){return c}})}),W.require("sMeteogram")});h.setZoom(10,{animate:!1}),f.set("overlay","clouds"),this.onopen=function(e){var g,i;if(!e){var p=h.getCenter();g=p.lat,i=p.lng}else g=e.lat,i=e.lon;var k=h.getBounds(),m=k.getEast()-k.getWest(),n=i-300*(m/h.getSize().x);h.panTo({lng:n,lat:g});var o={lng:i,lat:g};j?j.setLatLng(o):j=L.marker(o,{icon:h.myMarkers.pulsatingIcon,zIndexOffset:-300}).addTo(h),d.init(g,i),l(g,i),null!=a&&f.off(a),a=f.on("product",function(){return l(g,i)}),b.node.oncontextmenu=b.node.ondblclick=b.node.onclick=function(a){return a.stopPropagation()}};var l=function(a,b){var c=/gfs|ecmwf|nam\w+|iconEu/,e=f.get("product");c.test(e)||(e="ecmwf"),document.getElementById("sounding-model").innerText=e.toUpperCase();var g={model:e,lat:a,lon:b};Promise.all([i("airData",g),i("forecast",g),k]).then(function(a){var b=_slicedToArray(a,3),c=b[0],e=b[1],f=b[2];d.load(c.data,e.data,f)})};this.onclose=function(){null!=a&&(f.off(a),a=null),j&&(h.removeLayer(j),j=null)}}),W.define("windy-plugin-sounding/soundingGraph",["overlays","broadcast","favs","store","$","utils","windy-plugin-sounding/soundingUtils"],function(a,b,c,f,g,e,i){var m=Math.round,n=Math.pow,o=Math.min;function j(a){var b=Number.MIN_VALUE,c=Number.MAX_VALUE,f=c,g=b,h=c,i=b,j=c,k=b,l=b,m=function(a){var b=q.data[a];b.forEach(function(a,c){var d=Math.max;0==c&&(h=o(h,a.gh),k=d(k,a.pressure)),c==b.length-1&&(i=d(i,a.gh),j=o(j,a.pressure)),f=o(f,a.dewpoint),g=d(g,a.temp);var m=e.wind2obj([a.wind_u,a.wind_v]).wind;l=d(l,m)})};for(var w in q.data)m(w);f=243,g=303,p.domain([f,g]),u.domain([x(f),x(g)]),s.domain([0,30/3.6,l]),s.range([0,50,100]),v.domain([0,30,y(l)]),v.range([0,50,100]),r.domain([k,j]),z.domain([P(h),P(i)]);var n=a.map(function(a){return(q.mgCanvas.height-1)*(1-a/100)});t=d3.scaleLinear().range(n).domain([1e3,950,925,900,850,800,700,600,500,400,300,200,150,100])}function k(a,b,c,d){var e=a.data["".concat(b,"-").concat(c)];return Array.isArray(e)?e[d]:null}function l(a,b,c,d){var e=k(a,"gh",b,c);if(null!=e)return e;var f=-.0065,g=288.15/f*(n(d/1013.25,-f*287.053/9.80665)-1);return m(g)}var p,r,s,t,u,v,z,A,B,C,D,E,F,G,H,I=g("#sounding-chart"),J=100,K=I.clientWidth-100-20-15,M=580,N=preact,O=N.h,d=N.render,h=.4,q={lat:0,lon:0,elevation:0,data:{}},w=[],x=a.temp.convertNumber,y=a.wind.convertNumber,P=function(b){return m("ft"===a.cloudtop.metric?3.28084*b:b)},Q=function(a,g){if(q.lat=a,q.lon=g,q.data=null,p)return void R();p=d3.scaleLinear().range([0,K]),s=d3.scaleLinear().range([0,J]),r=d3.scaleLog().range([M,0]),u=d3.scaleLinear().range([0,K]),z=d3.scaleLinear().range([M,0]),v=d3.scaleLinear().range([0,J]),A=d3.axisBottom(u).ticks(5,"-d"),C=d3.axisRight(z).ticks(10,"d"),B=d3.axisBottom(v).ticks(3,"d"),D=d3.line().x(function(a){return p(a.temp)+h*(M-r(a.pressure))}).y(function(a){return r(a.pressure)}),E=d3.line().x(function(a){return p(a.dewpoint)+h*(M-r(a.pressure))}).y(function(a){return r(a.pressure)}),F=d3.line().x(function(a){return s(e.wind2obj([a.wind_u,a.wind_v]).wind)}).y(function(a){return r(a.pressure)});var i=function(a){var b=a.temp;if(0==h)return null;var c=p(b+273);return O("line",{x1:c,y1:M,x2:K,y2:M-(K-c)/h,stroke:"darkred","stroke-width":"0.2"})},j=function(a){for(var b=Math.log,c=a.q,d=[],e=M/6,f=M;f>-e;f-=e){var g=r.invert(f),i=n(b(g*c/(c+622)/6.11),-1),j=273+n(17.269/237.3*(i-1/17.269),-1);d.push({t:j,p:g})}var k=d3.line().x(function(a){return p(a.t)+h*(M-r(a.p))}).y(function(a){return r(a.p)});return O("path",{fill:"none",stroke:"blue","stroke-width":"0.3","stroke-dasharray":"2",d:k(d)})},k=function(a){for(var b=a.temp,c=[],d=M/15,e=M;e>-d;e-=d){var f=r.invert(e),g=(b+273)*n(1e3/f,-287/1030);c.push({t:g,p:f})}var i=d3.line().x(function(a){return p(a.t)+h*(M-r(a.p))}).y(function(a){return r(a.p)});return O("path",{fill:"none",stroke:"green","stroke-width":"0.3",d:i(c)})},l=function(a){for(var b=Math.exp,c=a.temp,d=[],e=1030,f=25e5,g=287,i=c+273,j=1e3,k=M/15,l=M;l>-k;l-=k){var m=r.invert(l),n=f/461*(1/273-1/i),o=6.11*b(n)*(.622/m),q=f*o/(g*i),s=g*i/(e*m)*(1+q),u=1+q*(.622*f/(e*i));i-=s/u*(j-m),j=m,d.push({t:i,p:m})}var v=d3.line().x(function(a){return p(a.t)+h*(M-r(a.p))}).y(function(a){return r(a.p)});return O("path",{fill:"none",stroke:"green","stroke-width":"0.3","stroke-dasharray":"3 5",d:v(d)})},w=function(a){var b=a.wind_u,c=a.wind_v,d=a.y,f=e.wind2obj([b,c]);return O("g",null,1<f.wind?O("g",{transform:"translate(0,".concat(d,") rotate(").concat(f.dir,")"),stroke:"black",fill:"none"},O("line",{y2:"-30"}),O("path",{d:"M-4,-8L0,0L4,-8","stroke-linejoin":"round"})):O("g",{transform:"translate(0,".concat(d,")"),stroke:"black",fill:"none"},O("circle",{r:"6"}),O("circle",{r:"1"})))},x=function(a){var b=a.elevation;if(null==b)return null;var c=m(z(b));return c>=M?null:O("rect",{class:"surface",x:"10",y:c,width:K+20+J,height:M-c})},N=function(a){var b=a.y,c=a.height,d=a.width,e=a.cover;return O("rect",_extends({y:b,height:c,width:d},{x:"0",fill:"rgba(".concat(e,", ").concat(e,", ").concat(e,", 0.8)")}))},P=function(){for(var a,b=f.get("timestamp"),c=q.mgCanvas,d=c.width,e=c.height,g=m((d-1)/(q.maxTs-q.minTs)*(b-q.minTs)),h=c.getContext("2d").getImageData(g,0,1,e).data,i=o(M,m(z(q.elevation))),j=function(a){var b=r.invert(a),c=m(t(b));return h[4*c]},k=[],l=30,n=m(t(r.invert(l))),p=255,s=!1,u=0;u<n;u++)a=h[4*u],0<a&&(s=!0,p=o(a,p));for(s&&k.push(O(N,{y:"0",width:K,height:"30",cover:p}));l<i;){for(var v=l,w=j(l),x=1;l++<i&&j(l)==w;)x++;0!=w&&k.push(O(N,{y:v,width:"100",height:x,cover:w}))}return O("g",{children:k})},S=function(a){Q(a.lat,a.lon),b.emit("rqstOpen","windy-plugin-sounding",a)},T=function(a){var b=a.favs,c=Object.values(b),d=e.latLon2str(q);return O("div",{id:"fly-to",class:"size-s"},0==c.length?O("span",{"data-icon":"m"},"Add favorites to enable fly to."):c.map(function(a){return O("span",{class:"location + ".concat(e.latLon2str(a)==d?" selected":""),onClick:function b(){return S(a)}},a.title||a.name)}))},U=Date.now(),V=function(a){var b=Math.sign,c=f.get("timestamp"),e=100,g=b(event.deltaY);if(a.shiftKey||a.ctrlKey){e=800;var h=new Date(c),d=h.getUTCHours();h.setUTCMinutes(0),c=h.getTime();var i=(13-q.tzOffset+24)%24,j=(i-d)*g;c+=0>=j?1e3*(3600*(g*(24+j))):1e3*(3600*(g*j))}else c+=1e3*(3600*g);Date.now()-U>e&&(f.set("timestamp",c),U=Date.now()),a.stopPropagation(),a.preventDefault()};G=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},b=a.data,d=a.elevation;return O("div",null,O("svg",{id:"sounding",onWheel:V},O("defs",null,O("clipPath",{id:"clip-chart"},O("rect",{x:"0",y:"0",width:K,height:M+20}))),b?O("g",null,O(x,{elevation:d}),O("g",{class:"wind"},O("g",{class:"chart",transform:"translate(".concat(K+30,",0)")},O("g",{class:"x axis",transform:"translate(0,".concat(M,")"),ref:function b(a){return d3.select(a).call(B)}}),O("line",{y1:M,y2:"0",stroke:"black","stroke-width":"0.2","stroke-dasharray":"3"}),O("line",{y1:M,x1:s(15/3.6),y2:"0",x2:s(15/3.6),stroke:"black","stroke-width":"0.2","stroke-dasharray":"3"}),O("rect",{x:J/2,width:J/2,height:M,fill:"red",opacity:"0.1"}),O("g",{class:"chartArea","clip-path":"url(#clip-chart)"},O("path",{class:"infoline wind",d:F(b)}),O("g",{transform:"translate(".concat(J/2,",0)")},b.map(function(a){return O(w,{wind_u:a.wind_u,wind_v:a.wind_v,y:r(a.pressure)})}))))),O("g",{class:"chart",transform:"translate(10,0)"},O(P,null),O("g",{class:"axis"},O("g",{class:"x axis",transform:"translate(0,".concat(M,")"),ref:function b(a){return d3.select(a).call(A)}}),O("g",{class:"y axis",y:M+16,ref:function b(a){return d3.select(a).call(C)}})),O("g",{class:"chartArea","clip-path":"url(#clip-chart)"},O("rect",{class:"overlay",width:K,height:M,opacity:"0"}),O("path",{class:"infoline temperature",d:D(b)}),O("path",{class:"infoline dewpoint",d:E(b)}),[-70,-60,-50,-40,-30,-20,-10,0,10,20].map(function(a){return O(i,{temp:a})}),[-20,-10,0,5,10,15,20,25,30,40,50,60,70,80].map(function(a){return O(k,{temp:a})}),[-20,-10,0,5,10,15,20,25,30,35].map(function(a){return O(l,{temp:a})}),[.01,.1,.5,1,2,5,8,12,16,20].map(function(a){return O(j,{q:a})})))):O("text",{x:"50%",y:"50%","text-anchor":"middle"},"No Data")),O(T,{favs:c.getAll()}))},H=d(O(G,{display:"block",elevation:"0"}),I,H),f.on("timestamp",R)},R=function(){if(w=null,q.data){var a,b,c=f.get("timestamp"),e=Object.getOwnPropertyNames(q.data).sort(function(c,a){return+c<+a?-1:1}),g=e.findIndex(function(a){return a>=c});-1<g&&(0==g?a=b=e[0]:(a=e[g-1],b=e[g]),w=i.interpolateArray(q.data[a],q.data[b],b==a?0:(c-a)/(b-a)))}H=d(O(G,{data:w,elevation:q.elevation,display:"block"}),I,H)};return{load:function r(a,b,c){var d=a.data.hours,e=new Set,f=new Set;for(var s in a.data){var t=s.match(/([^-]+)-(.+)h$/);null!==t&&(e.add(t[1]),f.add(+t[2]))}var g=Array.from(f).filter(function(a){return a>300}).sort(function(c,a){return+c<+a?1:-1}),h={};d.forEach(function(b,c){h[b]=[],g.forEach(function(d){var e="".concat(d,"h"),f=l(a,e,c,d);h[b].push({temp:k(a,"temp",e,c),dewpoint:k(a,"dewpoint",e,c),gh:f,wind_u:k(a,"wind_u",e,c),wind_v:k(a,"wind_v",e,c),pressure:d})})});var i=document.createElement("canvas"),n=a.data.hours.length,o=300/c.canvasRatio;c.init(i,n,6,o).setHeight(o).setOffset(0).render(a).resetCanvas(),q.data=h,q.mgCanvas=i,q.minTs=a.data.hours[0],q.maxTs=a.data.hours[a.data.hours.length-1];var p=null==b.header.elevation?0:b.header.elevation;null!=a.header.elevation&&(p=a.header.elevation),null!=a.header.modelElevation&&(p=a.header.modelElevation),q.elevation=p,q.tzOffset=b.celestial.TZoffset,j(c.hrAlt),R()},init:Q}}),W.define("windy-plugin-sounding/soundingUtils",[],function(){function a(a,b,c){var d={},e=Object.getOwnPropertyNames(a);return e.forEach(function(e){d[e]=(1-c)*a[e]+c*b[e]}),d}return{interpolateArray:function(b,c,d){var e=[];return b.forEach(function(b,f){var g=b.pressure,h=0==f?c[0]:c.find(function(a){return a.pressure==g});h&&e.push(a(b,h,d))}),e}}});