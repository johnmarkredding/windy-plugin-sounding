"use strict";function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}W.loadPlugin({name:"windy-plugin-sounding",version:"0.4.5",author:"Victor Berchet",repository:{type:"git",url:"git+https://github.com/vicb/windy-plugin-sounding"},description:"Soundings for paraglider pilots.",displayName:"Better Sounding",hook:"contextmenu",dependencies:["https://cdn.jsdelivr.net/npm/d3@5/dist/d3.min.js","https://cdn.jsdelivr.net/npm/preact@8/dist/preact.min.js"],className:"plugin-lhpane plugin-mobile-fullscreen",exclusive:"lhpane"},"<div class=\"plugin-content\"> <div class=\"title\">Sounding forecast <span id=\"sounding-model\"></span></div> <div id=\"sounding-chart\"></div> </div>",".onwindy-plugin-sounding .left-border{left:600px}.onwindy-plugin-sounding #search{display:none}#windy-plugin-sounding{font-size:12px;padding:1em 1em;line-height:2;z-index:100;width:600px}#windy-plugin-sounding .title{margin:0 0 .3em .6em;font-size:16px}#windy-plugin-sounding .closing-x{display:block}@media only screen and (max-device-width:736px){#windy-plugin-sounding{display:block;left:0;top:0;right:0;width:calc(100% - 20px);margin:10px}}#windy-plugin-sounding .axis path,#windy-plugin-sounding .axis line{fill:none;stroke:#000;shape-rendering:crispEdges}#windy-plugin-sounding #sounding-chart svg{width:100%;height:600px}#windy-plugin-sounding #sounding-chart .infoline{stroke-width:1.5;fill:none;stroke-linejoin:round;stroke-linecap:round}#windy-plugin-sounding #sounding-chart .infoline.dewpoint{stroke:steelblue}#windy-plugin-sounding #sounding-chart .infoline.temperature{stroke:red}#windy-plugin-sounding #sounding-chart .infoline.wind{stroke:purple}#windy-plugin-sounding #sounding-chart .surface{fill:brown;opacity:.2}#windy-plugin-sounding #fly-to{padding:0 15px 0 8px}#windy-plugin-sounding #fly-to .location{border:1px solid #bbb;border-radius:1em;line-height:1em;padding:.3em .6em;user-select:none;display:inline-block;margin-right:.3em;cursor:pointer}#windy-plugin-sounding #fly-to .selected{background-color:#946051;border-color:#946051;color:white}",function(){var a,b=this,d=W.require("windy-plugin-sounding/soundingGraph"),e=W.require("store"),f=W.require("pluginDataLoader"),g=W.require("map"),h=f({key:"QKlmnpLWr2rZSyFaT7LpxZc0d5bo34D4",plugin:"windy-plugin-sounding"}),i=null;g.setZoom(8,{animate:!1}),e.set("overlay","clouds"),this.onopen=function(f){var h,k;if(!f){var p=g.getCenter();h=p.lat,k=p.lng}else h=f.lat,k=f.lon;var l=g.getBounds(),m=l.getEast()-l.getWest(),n=k-300*(m/g.getSize().x);g.panTo({lng:n,lat:h});var o={lng:k,lat:h};i?i.setLatLng(o):i=L.marker(o,{icon:g.myMarkers.pulsatingIcon,zIndexOffset:-300}).addTo(g),d.init(),j(h,k),null!=a&&e.off(a),a=e.on("product",function(){return j(h,k)}),b.node.oncontextmenu=b.node.ondblclick=b.node.onclick=function(a){return a.stopPropagation()}};var j=function(a,b){var c=/gfs|ecmwf|nam\w+/,f=e.get("product");c.test(f)||(f="ecmwf"),document.getElementById("sounding-model").innerText=f.toUpperCase();var g={model:f,lat:a,lon:b};Promise.all([h("airData",g),h("forecast",g)]).then(function(c){var e=_slicedToArray(c,2),f=e[0],g=e[1];return d.load(a,b,f.data,g.data)})};this.onclose=function(){null!=a&&(e.off(a),a=null),i&&(g.removeLayer(i),i=null)}}),W.define("windy-plugin-sounding/soundingGraph",["overlays","broadcast","store","$","utils","windy-plugin-sounding/soundingUtils"],function(a,b,c,d,e,f){var k=Math.round,l=Math.pow;function g(){var a=Number.MIN_VALUE,b=Number.MAX_VALUE,c=b,f=a,g=b,h=a,i=b,j=a,k=a,l=function(a){var b=H.data[a];b.forEach(function(a,d){var l=Math.max,m=Math.min;0==d&&(g=m(g,a.gh),j=l(j,a.pressure)),d==b.length-1&&(h=l(h,a.gh),i=m(i,a.pressure)),c=m(c,a.dewpoint),f=l(f,a.temp);var n=e.wind2obj([a.wind_u,a.wind_v]).wind;k=l(k,n)})};for(var s in H.data)l(s);c=243,f=303,m.domain([c,f]),p.domain([J(c),J(f)]),o.domain([0,30/3.6,k]),o.range([0,50,100]),q.domain([0,30,K(k)]),q.range([0,50,100]),n.domain([j,i]),r.domain([M(g),M(h)])}function i(a,b,c,d){var e=a.data["".concat(b,"-").concat(c)];return Array.isArray(e)?e[d]:null}function j(a,b,c,d){var e=i(a,"gh",b,c);if(null!=e)return e;var f=-.0065,g=288.15/f*(l(d/1013.25,-f*287.053/9.80665)-1);return k(g)}var m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=d("#sounding-chart"),B=100,C=A.clientWidth-100-20-15,D=580,E=preact,F=E.h,h=E.render,G=.4,H={lat:0,lon:0,elevation:0,data:{}},I=[],J=a.temp.convertNumber,K=a.wind.convertNumber,M=function(b){return k("ft"===a.cloudtop.metric?3.28084*b:b)},N=function(){if(!m){m=d3.scaleLinear().range([0,C]),o=d3.scaleLinear().range([0,B]),n=d3.scaleLog().range([D,0]),p=d3.scaleLinear().range([0,C]),r=d3.scaleLinear().range([D,0]),q=d3.scaleLinear().range([0,B]),s=d3.axisBottom(p).ticks(5,"-d"),u=d3.axisRight(r).ticks(10,"d"),t=d3.axisBottom(q).ticks(3,"d"),v=d3.line().x(function(a){return m(a.temp)+G*(D-n(a.pressure))}).y(function(a){return n(a.pressure)}),w=d3.line().x(function(a){return m(a.dewpoint)+G*(D-n(a.pressure))}).y(function(a){return n(a.pressure)}),x=d3.line().x(function(a){return o(e.wind2obj([a.wind_u,a.wind_v]).wind)}).y(function(a){return n(a.pressure)});var a=function(a){var b=a.temp;if(0==G)return null;var c=m(b+273);return F("line",{x1:c,y1:D,x2:C,y2:D-(C-c)/G,stroke:"darkred","stroke-width":"0.2"})},d=function(a){for(var b=Math.log,c=a.q,d=[],e=D/6,f=D;f>-e;f-=e){var g=n.invert(f),h=l(b(g*c/(c+622)/6.11),-1),i=273+l(17.269/237.3*(h-1/17.269),-1);d.push({t:i,p:g})}var j=d3.line().x(function(a){return m(a.t)+G*(D-n(a.p))}).y(function(a){return n(a.p)});return F("path",{fill:"none",stroke:"blue","stroke-width":"0.3","stroke-dasharray":"2",d:j(d)})},g=function(a){for(var b=a.temp,c=[],d=D/15,e=D;e>-d;e-=d){var f=n.invert(e),g=(b+273)*l(1e3/f,-287/1030);c.push({t:g,p:f})}var h=d3.line().x(function(a){return m(a.t)+G*(D-n(a.p))}).y(function(a){return n(a.p)});return F("path",{fill:"none",stroke:"green","stroke-width":"0.3",d:h(c)})},i=function(a){for(var b=Math.exp,c=a.temp,d=[],e=1030,f=25e5,g=287,h=c+273,i=1e3,j=D/15,k=D;k>-j;k-=j){var l=n.invert(k),o=f/461*(1/273-1/h),p=6.11*b(o)*(.622/l),q=f*p/(g*h),r=g*h/(e*l)*(1+q),s=1+q*(1555000/(e*h));h-=r/s*(i-l),i=l,d.push({t:h,p:l})}var u=d3.line().x(function(a){return m(a.t)+G*(D-n(a.p))}).y(function(a){return n(a.p)});return F("path",{fill:"none",stroke:"green","stroke-width":"0.3","stroke-dasharray":"3 5",d:u(d)})},j=function(a){var b=a.wind_u,c=a.wind_v,d=a.y,f=e.wind2obj([b,c]);return F("g",null,1<f.wind?F("g",{transform:"translate(0,".concat(d,") rotate(").concat(f.dir,")"),stroke:"black",fill:"none"},F("line",{y2:"-30"}),F("path",{d:"M-4,-8L0,0L4,-8","stroke-linejoin":"round"})):F("g",{transform:"translate(0,".concat(d,")"),stroke:"black",fill:"none"},F("circle",{r:"6"}),F("circle",{r:"1"})))},E=function(a){var b=a.elevation;if(null==b)return null;var c=k(r(b));return c>=D?null:F("rect",{class:"surface",x:"10",y:c,width:C+20+B,height:D-c})},I=function(a){b.emit("rqstOpen","windy-plugin-sounding",a)},J=function(a){var b=a.places;return F("div",{id:"fly-to",class:"size-s"},0==b.length?F("span",{"data-icon":"m"},"Add favorites to enable fly to."):b.map(function(a){var b=H.lat==a.lat&&H.lon==a.lon;return F("span",{class:"location".concat(b?" selected":""),onClick:function b(){return I(a)}},a.title||a.name)}))},K=function(a){var b=Math.sign,e=c.get("timestamp"),f=b(event.deltaY);if(a.shiftKey||a.ctrlKey){var g=new Date(e),d=g.getUTCHours(),h=(13-H.tzOffset+24)%24,i=(h-d)*f;e+=0>=i?1e3*(3600*(f*(24+i))):1e3*(3600*(f*i))}else e+=1e3*(3600*f);c.set("timestamp",e),a.stopPropagation(),a.preventDefault()};y=function(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},c=b.data,e=b.elevation;return F("div",null,F("svg",{id:"sounding",onWheel:K},F("defs",null,F("clipPath",{id:"clip-chart"},F("rect",{x:"0",y:"0",width:C,height:D+20}))),c?F("g",null,F(E,{elevation:e}),F("g",{class:"wind"},F("g",{class:"chart",transform:"translate(".concat(C+30,",0)")},F("g",{class:"x axis",transform:"translate(0,".concat(D,")"),ref:function b(a){return d3.select(a).call(t)}}),F("line",{y1:D,y2:"0",stroke:"black","stroke-width":"0.2","stroke-dasharray":"3"}),F("line",{y1:D,x1:o(15/3.6),y2:"0",x2:o(15/3.6),stroke:"black","stroke-width":"0.2","stroke-dasharray":"3"}),F("rect",{x:B/2,width:B/2,height:D,fill:"red",opacity:"0.1"}),F("g",{class:"chartArea","clip-path":"url(#clip-chart)"},F("path",{class:"infoline wind",d:x(c)}),F("g",{transform:"translate(".concat(B/2,",0)")},c.map(function(a){return F(j,{wind_u:a.wind_u,wind_v:a.wind_v,y:n(a.pressure)})}))))),F("g",{class:"chart",transform:"translate(10,0)"},F("g",{class:"axis"},F("g",{class:"x axis",transform:"translate(0,".concat(D,")"),ref:function b(a){return d3.select(a).call(s)}}),F("g",{class:"y axis",y:D+16,ref:function b(a){return d3.select(a).call(u)}})),F("g",{class:"chartArea","clip-path":"url(#clip-chart)"},F("rect",{class:"overlay",width:C,height:D,opacity:"0"}),F("path",{class:"infoline temperature",d:v(c)}),F("path",{class:"infoline dewpoint",d:w(c)}),[-70,-60,-50,-40,-30,-20,-10,0,10,20].map(function(b){return F(a,{temp:b})}),[-20,-10,0,5,10,15,20,25,30,40,50,60,70,80].map(function(a){return F(g,{temp:a})}),[-20,-10,0,5,10,15,20,25,30,35].map(function(a){return F(i,{temp:a})}),[.01,.1,.5,1,2,5,8,12,16,20].map(function(a){return F(d,{q:a})})))):F("text",{x:"50%",y:"50%","text-anchor":"middle"},"No Data")),F(J,{places:f.getFavorites()}))},z=h(F(y,{display:"block",elevation:"0"}),A,z),c.on("timestamp",O)}},O=function(){if(I=null,H.data){var a,b,d=c.get("timestamp"),e=Object.getOwnPropertyNames(H.data).sort(function(c,a){return+c<+a?-1:1}),g=e.findIndex(function(a){return a>=d});-1<g&&(0==g?a=b=e[0]:(a=e[g-1],b=e[g]),I=f.interpolateArray(H.data[a],H.data[b],b==a?0:(d-a)/(b-a)))}z=h(F(y,{data:I,elevation:H.elevation,display:"block"}),A,z)};return{load:function o(a,b,c,d){var e=c.data.hours,f=new Set,h=new Set;for(var p in c.data){var q=p.match(/([^-]+)-(.+)h$/);null!==q&&(f.add(q[1]),h.add(+q[2]))}var k=Array.from(h).filter(function(a){return 300<a}).sort(function(c,a){return+c<+a?1:-1}),l={};e.forEach(function(a,b){l[a]=[],k.forEach(function(d){var e="".concat(d,"h"),f=j(c,e,b,d);l[a].push({temp:i(c,"temp",e,b),dewpoint:i(c,"dewpoint",e,b),gh:f,wind_u:i(c,"wind_u",e,b),wind_v:i(c,"wind_v",e,b),pressure:d})})}),H.lat=a,H.lon=b,H.data=l;var n=null==d.header.elevation?0:d.header.elevation;null!=c.header.modelElevation&&(n=c.header.modelElevation),null!=c.header.elevation&&(n=c.header.elevation),H.elevation=n,H.tzOffset=d.celestial.TZoffset,g(H),O()},init:N}}),W.define("windy-plugin-sounding/soundingUtils",[],function(){function a(a,b,c){var d={},e=Object.getOwnPropertyNames(a);return e.forEach(function(e){d[e]=(1-c)*a[e]+c*b[e]}),d}return{interpolateArray:function(b,c,d){var e=[];return b.forEach(function(b,f){var g=b.pressure,h=0==f?c[0]:c.find(function(a){return a.pressure==g});h&&e.push(a(b,h,d))}),e},getFavorites:function(){try{var a=JSON.parse(localStorage.getItem("favs"));return Object.keys(a).map(function(b){return a[b]})}catch(a){return[]}}}});