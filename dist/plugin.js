/**
 * @fileoverview Description of this file.
 */
"use strict";function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _extends(){return _extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},_extends.apply(this,arguments)}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}W.loadPlugin({name:"windy-plugin-sounding",version:"0.6.0",author:"Victor Berchet",repository:{type:"git",url:"git+https://github.com/vicb/windy-plugin-sounding"},description:"Soundings for paraglider pilots.",displayName:"Better Sounding",hook:"contextmenu",dependencies:["https://cdn.jsdelivr.net/npm/d3@5/dist/d3.min.js","https://cdn.jsdelivr.net/npm/preact@8/dist/preact.min.js"],className:"plugin-lhpane plugin-mobile-fullscreen",exclusive:"lhpane"},"<div class=\"plugin-content\"> <div class=\"title\">Sounding forecast <span id=\"sounding-model\"></span></div> <div id=\"sounding-chart\"></div> </div>",".onwindy-plugin-sounding .left-border{left:600px}.onwindy-plugin-sounding #search{display:none}#windy-plugin-sounding{font-size:12px;padding:1em 1em;line-height:2;z-index:100;width:600px}#windy-plugin-sounding .title{margin:0 0 .3em .6em;font-size:16px}#windy-plugin-sounding .closing-x{display:block}@media only screen and (max-device-width:736px){#windy-plugin-sounding{display:block;left:0;top:0;right:0;width:calc(100% - 20px);margin:10px}}#windy-plugin-sounding .axis path,#windy-plugin-sounding .axis line{fill:none;stroke:#000;shape-rendering:crispEdges}#windy-plugin-sounding #sounding-chart svg{width:100%;height:600px}#windy-plugin-sounding #sounding-chart .cumulus{fill:#030104}#windy-plugin-sounding #sounding-chart .infoline{stroke-width:3;fill:none;stroke-linejoin:round;stroke-linecap:round}#windy-plugin-sounding #sounding-chart .infoline.dewpoint{stroke:steelblue}#windy-plugin-sounding #sounding-chart .infoline.temperature{stroke:red}#windy-plugin-sounding #sounding-chart .infoline.wind{stroke:purple}#windy-plugin-sounding #sounding-chart .infoline.parcel{stroke:darkorange;stroke-width:2}#windy-plugin-sounding #sounding-chart .moist{fill:none;stroke:green;stroke-width:.3;stroke-dasharray:4 6}#windy-plugin-sounding #sounding-chart .dry{fill:none;stroke:green;stroke-width:.3}#windy-plugin-sounding #sounding-chart .isohume{fill:none;stroke:blue;stroke-width:.3;stroke-dasharray:4 6}#windy-plugin-sounding #sounding-chart .parcel{stroke-width:2;stroke-dasharray:None}#windy-plugin-sounding #sounding-chart .parcel.moist{stroke:#77ce06}#windy-plugin-sounding #sounding-chart .parcel.dry{stroke:#77ce06}#windy-plugin-sounding #sounding-chart .parcel.isohume{stroke:gray;stroke-dasharray:3}#windy-plugin-sounding #sounding-chart .surface{fill:brown;opacity:.2}#windy-plugin-sounding #fly-to{padding:0 15px 0 8px}#windy-plugin-sounding #fly-to .location{border:1px solid #bbb;border-radius:1em;line-height:1em;padding:.3em .6em;user-select:none;display:inline-block;margin-right:.3em;cursor:pointer}#windy-plugin-sounding #fly-to .selected{background-color:#d49500;border-color:#d49500;color:white}",function(){var a,b=this,d=W.require("windy-plugin-sounding/soundingGraph"),e=W.require("plugins"),f=W.require("store"),g=W.require("pluginDataLoader"),h=W.require("map"),i=g({key:"QKlmnpLWr2rZSyFaT7LpxZc0d5bo34D4",plugin:"windy-plugin-sounding"}),j=null,k=e["detail-render"].load().then(function(){return W.define("sMeteogram",["meteogram","Class"],function(a,b){var c=this;return b.extend(a,{legend:function a(){return c}})}),W.require("sMeteogram")});h.setZoom(10,{animate:!1}),f.set("overlay","clouds"),this.onopen=function(e){var g,i;if(!e){var p=h.getCenter();g=p.lat,i=p.lng}else g=e.lat,i=e.lon;var k=h.getBounds(),m=k.getEast()-k.getWest(),n=i-300*(m/h.getSize().x);h.panTo({lng:n,lat:g});var o={lng:i,lat:g};j?j.setLatLng(o):j=L.marker(o,{icon:h.myMarkers.pulsatingIcon,zIndexOffset:-300}).addTo(h),d.init(g,i),l(g,i),null!=a&&f.off(a),a=f.on("product",function(){return l(g,i)}),b.node.oncontextmenu=b.node.ondblclick=b.node.onclick=function(a){return a.stopPropagation()}};var l=function(a,b){var c=/gfs|ecmwf|nam\w+|iconEu/,e=f.get("product");c.test(e)||(e="ecmwf"),document.getElementById("sounding-model").innerText=e.toUpperCase();var g={model:e,lat:a,lon:b};Promise.all([i("airData",g),i("forecast",g),k]).then(function(a){var b=_slicedToArray(a,3),c=b[0],e=b[1],f=b[2];d.load(c.data,e.data,f)})};this.onclose=function(){null!=a&&(f.off(a),a=null),j&&(h.removeLayer(j),j=null)}}),W.define("windy-plugin-sounding/soundingGraph",["overlays","broadcast","favs","store","$","utils","windy-plugin-sounding/soundingUtils","windy-plugin-sounding/atmosphere","windy-plugin-sounding/math"],function(a,b,c,f,g,e,i,j,k){var o=Math.sign,q=Math.round,r=Math.max,s=Math.min;function l(a){var b=Number.MIN_VALUE,c=Number.MAX_VALUE,f=c,g=b,h=c,i=b,j=c,k=b,l=b,m=function(a){var b=S.data[a];b.forEach(function(a,c){0==c&&(h=s(h,a.gh),k=r(k,a.pressure)),c==b.length-1&&(i=r(i,a.gh),j=s(j,a.pressure)),f=s(f,a.dewpoint),g=r(g,a.temp);var d=e.wind2obj([a.wind_u,a.wind_v]).wind;l=r(l,d)})};for(var o in S.data)m(o);f=243,g=303,t.domain([f,g]),A.domain([U(f),U(g)]),v.domain([0,30/3.6,l]),v.range([0,50,100]),B.domain([0,30,V(l)]),B.range([0,50,100]),u.domain([k,j]),C.domain([X(h),X(i)]);var n=a.map(function(a){return(S.mgCanvas.height-1)*(1-a/100)});z=d3.scaleLinear().range(n).domain([1e3,950,925,900,850,800,700,600,500,400,300,200,150,100])}function m(a,b,c,d){var e=a.data["".concat(b,"-").concat(c)];return Array.isArray(e)?e[d]:null}function n(a,b,c,d){var e=m(a,"gh",b,c);return null==e?q(j.getElevation(d)):e}var t,u,v,z,A,B,C,D,E,F,G,H,I,J,K,M=g("#sounding-chart"),N=100,O=M.clientWidth-100-20-15,P=580,Q=preact,R=Q.h,d=Q.render,h=.4,w=300,S={lat:0,lon:0,elevation:0,data:{}},T=[],U=a.temp.convertNumber,V=a.wind.convertNumber,X=function(b){return q("ft"===a.cloudtop.metric?3.28084*b:b)},Y=function(a,g){if(S.lat=a,S.lon=g,S.data=null,t)return void Z();t=d3.scaleLinear().range([0,O]),v=d3.scaleLinear().range([0,N]),u=d3.scaleLog().range([P,0]),A=d3.scaleLinear().range([0,O]),C=d3.scaleLinear().range([P,0]),B=d3.scaleLinear().range([0,N]),D=d3.axisBottom(A).ticks(5,"-d"),F=d3.axisRight(C).ticks(10,"d"),E=d3.axisBottom(B).ticks(3,"d"),G=d3.line().x(function(a){return t(a.temp)+h*(P-u(a.pressure))}).y(function(a){return u(a.pressure)}),H=d3.line().x(function(a){return t(a.dewpoint)+h*(P-u(a.pressure))}).y(function(a){return u(a.pressure)}),I=d3.line().x(function(a){return v(e.wind2obj([a.wind_u,a.wind_v]).wind)}).y(function(a){return u(a.pressure)});var i=function(a){var b=a.temp;if(0==h)return null;var c=t(b+273);return R("line",{x1:c,y1:P,x2:O,y2:P-(O-c)/h,stroke:"darkred","stroke-width":"0.2"})},l=function(a){for(var b=a.temp,c=[],d=j.mixingRatio(j.saturationVaporPressure(b+j.celsiusToK),1e3),e=P/6,f=P;f>-e;f-=e){var g=u.invert(f),i=j.dewpoint(j.vaporPressure(g,d));c.push({t:i,p:g})}var k=d3.line().x(function(a){return t(a.t)+h*(P-u(a.p))}).y(function(a){return u(a.p)});return R("path",{class:"isohume",d:k(c)})},m=function(a){for(var b=a.temp,c=[],d=b+j.celsiusToK,e=P/15,f=P;f>-e;f-=e){var g=u.invert(f),i=j.dryLapse(g,d,1e3);c.push({t:i,p:g})}var k=d3.line().x(function(a){return t(a.t)+h*(P-u(a.p))}).y(function(a){return u(a.p)});return R("path",{class:"dry",d:k(c)})},n=function(a){for(var b,c=a.temp,d=[],e=c+j.celsiusToK,f=e,g=1e3,i=P/15,k=P;k>-i;k-=i)b=u.invert(k),f+=(b-g)*j.moistGradientT(b,f),g=b,d.push({t:f,p:b});var l=d3.line().x(function(a){return t(a.t)+h*(P-u(a.p))}).y(function(a){return u(a.p)});return R("path",{class:"moist",d:l(d)})},p=function(a){var b=a.wind_u,c=a.wind_v,d=a.y,f=e.wind2obj([b,c]);return R("g",null,1<f.wind?R("g",{transform:"translate(0,".concat(d,") rotate(").concat(f.dir,")"),stroke:"black",fill:"none"},R("line",{y2:"-30"}),R("path",{d:"M-4,-8L0,0L4,-8","stroke-linejoin":"round"})):R("g",{transform:"translate(0,".concat(d,")"),stroke:"black",fill:"none"},R("circle",{r:"6"}),R("circle",{r:"1"})))},r=function(a){var b=a.elevation;if(null==b)return null;var c=q(C(b));return c>=P?null:R("rect",{class:"surface",x:"10",y:c,width:O+20+N,height:P-c})},x=function(a){var b=a.y,c=a.height,d=a.width,e=a.cover;return R("rect",_extends({y:b,height:c,width:d},{x:"0",fill:"rgba(".concat(e,", ").concat(e,", ").concat(e,", 0.8)")}))},y=function(a){var b=a.x,c=a.y;return R("path",{class:"cumulus",transform:"translate(".concat(b-32,", ").concat(c-32,")"),d:"M27.586,14.212C26.66,11.751,24.284,10,21.5,10c-0.641,0-1.26,0.093-1.846,0.266 C18.068,7.705,15.233,6,12,6c-4.905,0-8.893,3.924-8.998,8.803C1.208,15.842,0,17.783,0,20c0,3.312,2.687,6,6,6h20 c3.312,0,6-2.693,6-6C32,17.234,30.13,14.907,27.586,14.212z M26.003,24H5.997C3.794,24,2,22.209,2,20 c0-1.893,1.318-3.482,3.086-3.896C5.03,15.745,5,15.376,5,15c0-3.866,3.134-7,7-7c3.162,0,5.834,2.097,6.702,4.975 C19.471,12.364,20.441,12,21.5,12c2.316,0,4.225,1.75,4.473,4h0.03C28.206,16,30,17.791,30,20C30,22.205,28.211,24,26.003,24z"})},Q=function(){for(var a,b=f.get("timestamp"),c=S.mgCanvas,d=c.width,e=c.height,g=S.hours[0],h=S.hours[S.hours.length-1],i=q((d-1)/(h-g)*(b-g)),j=c.getContext("2d").getImageData(i,0,1,e).data,k=s(P,q(C(S.elevation))),l=function(a){var b=u.invert(a),c=q(z(b));return j[4*c]},m=[],n=30,o=q(z(u.invert(n))),p=255,r=!1,t=0;t<o;t++)a=j[4*t],0<a&&(r=!0,p=s(a,p));for(r&&m.push(R(x,{y:"0",width:O,height:"30",cover:p}));n<k;){for(var v=n,w=l(n),A=1;n++<k&&l(n)==w;)A++;0!=w&&m.push(R(x,{y:v,width:"100",height:A,cover:w}))}return R("g",{children:m})},T=function(a){Y(a.lat,a.lon),b.emit("rqstOpen","windy-plugin-sounding",a)},U=function(a){var b=a.favs,c=Object.values(b),d=e.latLon2str(S);return R("div",{id:"fly-to",class:"size-s"},0==c.length?R("span",{"data-icon":"m"},"Add favorites to enable fly to."):c.map(function(a){return R("span",{class:"location + ".concat(e.latLon2str(a)==d?" selected":""),onClick:function b(){return T(a)}},a.title||a.name)}))},V=function(a){var b=a.data,c=[],e=[],f=[];b.forEach(function(a){c.push(a.temp),e.push(a.dewpoint),f.push(a.pressure)});for(var g=u.invert(C(S.elevation)),i=3+k.sampleAt(f,c,[g])[0],l=k.sampleAt(f,e,[g])[0],m=[],n=[],o=[],q=20,r=j.mixingRatio(j.saturationVaporPressure(l),g),s=g;s>=w;s-=q)o.push(s),m.push(j.dryLapse(s,i,g)),n.push(j.dewpoint(j.vaporPressure(s,r)));var d=k.firstIntersection(o,m,o,n),v=k.firstIntersection(o,m,f,c),x=d3.line().y(function(a){return u(a[1])}).x(function(a){return t(a[0])+h*(P-u(a[1]))}),z=[],A=v;if(d&&d[0]>v[0]){A=d;for(var B=[],D=[],E=d[1],F=A[0];F>=w;F-=q)B.push(F),D.push(E),E-=q*j.moistGradientT(F,E);var M=d3.zip(n,o).filter(function(a){return a[1]>A[0]});M.push([d[1],d[0]]),z.push(R("path",{class:"parcel isohume",d:x(M)}));var G=d3.zip(D,B),H=k.firstIntersection(B,D,f,c),I=0;if(H){var N=H[0];I=u(N),z.push(R("line",{stroke:"gray","stroke-width":"1","stroke-dasharray":"3",y1:I,y2:I,x2:O})),G=G.filter(function(a){return a[1]>=N}),G.push([H[1],H[0]])}z.push(R("rect",{x:"0",y:I,height:u(A[0])-I,width:O,fill:"url(#diag-hatch)"})),z.push(R(y,{x:O,y:u(A[0])})),z.push(R("path",{class:"parcel moist",d:x(G)}))}var J=u(A[0]),K=d3.zip(m,o).filter(function(a){return a[1]>=A[0]});return K.push([A[1],A[0]]),z.push(R("line",{stroke:"gray","stroke-width":"1","stroke-dasharray":"3",y1:J,y2:J,x2:O})),z.push(R("path",{class:"parcel dry",d:x(K)})),R("g",{children:z})},X=Date.now(),$=function(a){var b=f.get("timestamp"),c=100,e=o(event.deltaY);if(a.shiftKey||a.ctrlKey){c=800;var g=new Date(b),d=g.getUTCHours();g.setUTCMinutes(0),b=g.getTime();var h=(13-S.tzOffset+24)%24,i=(h-d)*e;b+=0>=i?1e3*(3600*(e*(24+i))):1e3*(3600*(e*i))}else b+=1e3*(3600*e);Date.now()-X>c&&(f.set("timestamp",b),X=Date.now()),a.stopPropagation(),a.preventDefault()};J=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},b=a.data,d=a.elevation;return R("div",null,R("svg",{id:"sounding",onWheel:$},R("defs",null,R("clipPath",{id:"clip-chart"},R("rect",{x:"0",y:"0",width:O,height:P+20})),R("pattern",{id:"diag-hatch",patternUnits:"userSpaceOnUse",width:"8",height:"8",patternTransform:"rotate(45 2 2)"},R("path",{d:"M 0,-1 L 0,11",stroke:"gray","stroke-width":"0.5"}))),b?R("g",null,R(r,{elevation:d}),R("g",{class:"wind"},R("g",{class:"chart",transform:"translate(".concat(O+30,",0)")},R("g",{class:"x axis",transform:"translate(0,".concat(P,")"),ref:function b(a){return d3.select(a).call(E)}}),R("line",{y1:P,y2:"0",stroke:"black","stroke-width":"0.2","stroke-dasharray":"3"}),R("line",{y1:P,x1:v(15/3.6),y2:"0",x2:v(15/3.6),stroke:"black","stroke-width":"0.2","stroke-dasharray":"3"}),R("rect",{x:N/2,width:N/2,height:P,fill:"red",opacity:"0.1"}),R("g",{class:"chartArea","clip-path":"url(#clip-chart)"},R("path",{class:"infoline wind",d:I(b)}),R("g",{transform:"translate(".concat(N/2,",0)")},b.map(function(a){return R(p,{wind_u:a.wind_u,wind_v:a.wind_v,y:u(a.pressure)})}))))),R("g",{class:"chart",transform:"translate(10,0)"},R(Q,null),R("g",{class:"axis"},R("g",{class:"x axis",transform:"translate(0,".concat(P,")"),ref:function b(a){return d3.select(a).call(D)}}),R("g",{class:"y axis",y:P+16,ref:function b(a){return d3.select(a).call(F)}})),R("g",{class:"chartArea","clip-path":"url(#clip-chart)"},R("rect",{class:"overlay",width:O,height:P,opacity:"0"}),R("path",{class:"infoline temperature",d:G(b)}),R("path",{class:"infoline dewpoint",d:H(b)}),R(V,{data:b}),[-70,-60,-50,-40,-30,-20,-10,0,10,20].map(function(a){return R(i,{temp:a})}),[-20,-10,0,5,10,15,20,25,30,40,50,60,70,80].map(function(a){return R(m,{temp:a})}),[-20,-10,0,5,10,15,20,25,30,35].map(function(a){return R(n,{temp:a})}),[-20,-15,-10,-5,0,5,10,15,20].map(function(a){return R(l,{temp:a})})))):R("text",{x:"50%",y:"50%","text-anchor":"middle"},"No Data")),R(U,{favs:c.getAll()}))},K=d(R(J,{display:"block",elevation:"0"}),M,K),f.on("timestamp",Z)},Z=function(){if(T=null,S.sfcTemp=null,S.data){var a,b,c=f.get("timestamp"),e=S.hours,g=e.findIndex(function(a){return a>=c}),h=0;if(-1<g){0==g?a=b=e[0]:(a=e[g-1],b=e[g],h=(c-a)/(b-a)),T=i.interpolateArray(S.data[a],S.data[b],h);var j=S.sfcTempByTs[g-1];if(null!=j){var k=S.sfcTempByTs[g];S.sfcTemp=(1-h)*j+h*k}}}K=d(R(J,{data:T,elevation:S.elevation,display:"block"}),M,K)};return{load:function q(a,b,c){var d=a.data.hours,e=new Set,f=new Set;for(var r in a.data){var s=r.match(/([^-]+)-(.+)h$/);null!==s&&(e.add(s[1]),f.add(+s[2]))}var g=Array.from(f).filter(function(a){return a>w}).sort(function(c,a){return+c<+a?1:-1}),h={},i=[];d.forEach(function(b,c){h[b]=[],i.push(m(a,"temp","surface",c)),g.forEach(function(d){var e="".concat(d,"h"),f=n(a,e,c,d);h[b].push({temp:m(a,"temp",e,c),dewpoint:m(a,"dewpoint",e,c),gh:f,wind_u:m(a,"wind_u",e,c),wind_v:m(a,"wind_v",e,c),pressure:d})})});var j=document.createElement("canvas"),k=a.data.hours.length,o=300/c.canvasRatio;c.init(j,k,6,o).setHeight(o).setOffset(0).render(a).resetCanvas(),S.data=h,S.mgCanvas=j,S.hours=a.data.hours,S.sfcTempByTs=i;var p=null==b.header.elevation?0:b.header.elevation;null!=a.header.elevation&&(p=a.header.elevation),null!=a.header.modelElevation&&(p=a.header.modelElevation),S.elevation=p,S.tzOffset=b.celestial.TZoffset,l(c.hrAlt),Z()},init:Y}}),W.define("windy-plugin-sounding/soundingUtils",[],function(){function a(a,b,c){var d={},e=Object.getOwnPropertyNames(a);return e.forEach(function(e){d[e]=(1-c)*a[e]+c*b[e]}),d}return{interpolateArray:function(b,c,d){var e=[];return b.forEach(function(b,f){var g=b.pressure,h=0==f?c[0]:c.find(function(a){return a.pressure==g});h&&e.push(a(b,h,d))}),e}}}),W.define("windy-plugin-sounding/atmosphere",[],function(){var e=Math.pow;function a(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:f;return c*a/(b-a)}function b(b,d){return a(c(d),b)}function c(a){var b=a-h;return g*Math.exp(17.67*b/(b+243.5))}var f=18.01528/28.9644,g=6.112,h=273.15,i=-.0065;return{dryLapse:function(a,b,c){return b*e(a/c,287/1005)},moistGradientT:function(a,c){var g=b(a,c),h=1005+e(2501000,2)*g*f/(287*e(c,2));return 1/a*((287*c+2501000*g)/h)},dewpoint:function(a){var b=Math.log(a/g);return h+243.5*b/(17.67-b)},vaporPressure:function(a,b){return a*b/(f+b)},getElevation:function(a){return 288.15/i*(e(a/1013.25,-i*287/9.80665)-1)},saturationVaporPressure:c,mixingRatio:a,celsiusToK:h}}),W.define("windy-plugin-sounding/math",[],function(){var c=Math.sign;function a(a,b,c,d,e){if(a==c)return b;var f=(e-a)/(c-a);return b*(1-f)+d*f}function b(b,c,d){return d.map(function(d){var e=b.findIndex(function(a){return a<=d});return-1==e?e=b.length-1:0==e&&(e=1),a(b[e-1],c[e-1],b[e],c[e],d)})}return{firstIntersection:function(a,d,e,f){for(var g=Math.min(a[0],e[0]),h=Math.max(a[a.length-1],e[e.length-1]),i=Array.from(new Set([].concat(_toConsumableArray(a),_toConsumableArray(e)))).filter(function(a){return a>=h&&a<=g}).sort(function(c,a){return+c>+a?-1:1}),j=b(a,d,i),k=b(e,f,i),l=0;l<i.length-1;l++){var m=j[l],n=k[l],o=i[l];if(m==n)return[o,m];var p=j[l+1],q=k[l+1];if(c(n-m)!=c(q-p)){var r=i[l+1],s=r-o,t=(p-m)/s,u=(n-m)/(t-(q-n)/s);return[o+u,m+u*t]}}return null},sampleAt:b,linearInterpolate:a}});
