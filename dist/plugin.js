"use strict";function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){if(Array.isArray(a))return a}W.loadPlugin({name:"windy-plugin-sounding",version:"0.2.0",author:"Victor Berchet",repository:{type:"git",url:"git+https://github.com/vicb/windy-plugins"},description:"Soundings for paraglider pilots.",displayName:"Better Sounding",hook:"contextmenu",dependencies:["https://cdn.jsdelivr.net/npm/d3@5/dist/d3.min.js","https://cdn.jsdelivr.net/npm/preact@8/dist/preact.min.js"],className:"drop-down-window ",classNameMobile:"drop-down-window down",attachPoint:".leaflet-popup-pane",attachPointMobile:"#plugins"},"<h3>Sounding forecast</h3> <div id=\"sounding-chart\"></div>","#windy-plugin-sounding{font-size:12px;padding:.5em .7em;line-height:2;z-index:100;width:600px;height:650px;margin-left:-10px}#windy-plugin-sounding h3{margin:0 0 .3em .6em}#windy-plugin-sounding .closing-x{display:block}#windy-plugin-sounding section{margin-left:10px;line-height:1.5}#windy-plugin-sounding section span:not(:first-child){margin-left:1em}#windy-plugin-sounding section:first-of-type{color:black}#windy-plugin-sounding section:last-of-type{font-size:.9em}#windy-plugin-sounding section [data-ref=\"modelAlt\"].red{color:red}#windy-plugin-sounding [data-ref=\"zoom\"]{position:absolute;right:20px;bottom:15px;font-size:25px;color:#9d0300}@media only screen and (max-device-width:736px){#windy-plugin-sounding{display:block;left:0;top:0;right:0;width:calc(100% - 20px);margin:10px}}#windy-plugin-sounding .axis path,#windy-plugin-sounding .axis line{fill:none;stroke:#000;shape-rendering:crispEdges}#windy-plugin-sounding #sounding-chart{height:600px;position:relative}#windy-plugin-sounding #sounding-chart svg{width:100%;height:100%}#windy-plugin-sounding #sounding-chart .infoLine .dewpoint{fill:steelblue}#windy-plugin-sounding #sounding-chart .infoLine .temp{fill:red}#windy-plugin-sounding #sounding-chart .zoomButton{cursor:pointer}",function(){var a=this,b=W.require("windy-plugin-sounding/soundingGraph"),c=W.require("pluginDataLoader"),d=W.require("map"),e=W.require("rootScope"),f=c({key:"RxcwkWO2XWsfEbdidcsskbyWqhToAwLx",plugin:"windy-plugin-examples"}),g=null;this.onopen=function(b){var f,i;if(!b){var n=d.getCenter();f=n.lat,i=n.lng}else f=b.lat,i=b.lon;var j={lng:i,lat:f},k=d.latLngToLayerPoint(j),l=k.x,m=k.y;if(!e.isMobile)a.node.style.position="absolute",a.node.style.left="".concat(l-15,"px"),a.node.style.top="".concat(m+15,"px");else{var c=a.node.clientHeight;d.center({lat:f,lon:i},!1).panBy([0,-.5*c+50])}g?g.setLatLng(j):g=L.marker(j,{icon:d.myMarkers.pulsatingIcon,zIndexOffset:-300}).addTo(d),h(f,i),a.node.oncontextmenu=a.node.ondblclick=a.node.onclick=function(a){return a.stopPropagation()}};var h=function(c,d){var e={model:"ecmwf",lat:c,lon:d};b.init(a.refs),Promise.all([f("forecast",e),f("airData",e)]).then(function(a){var e=_slicedToArray(a,2),f=e[0],g=e[1];b.load(c,d,g.data,f.data)})};this.onclose=function(){g&&(d.removeLayer(g),g=null)}}),W.define("windy-plugin-sounding/soundingGraph",["overlays","store","$","utils","windy-plugin-sounding/soundingUtils"],function(a,b,c,e,d){var i=Math.round;function f(){var a=Number.MIN_VALUE,b=Number.MAX_VALUE,c=b,f=a,g=b,h=a,i=b,p=a,q=a,r=function(a){var b=E.data[a];b.forEach(function(a,d){var j=Math.max,k=Math.min;0==d&&(g=k(g,a.gh),p=j(p,a.pressure)),d==b.length-1&&(h=j(h,a.gh),i=k(i,a.pressure)),c=k(c,a.dewpoint),f=j(f,a.temp);var l=e.wind2obj([a.wind_u,a.wind_v]).wind;q=j(q,l)})};for(var s in E.data)r(s);c=243,f=303,j.domain([c,f]),m.domain([G(c),G(f)]),l.domain([0,30/3.6,q]),l.range([0,50,100]),n.domain([0,30,H(q)]),n.range([0,50,100]),k.domain([p,i]),o.domain([J(g),J(h)])}function g(a,b,c,d){return"gh"===b&&"surface"==c?a.header.modelElevation:a.data["".concat(b,"-").concat(c)][d]}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=c("#sounding-chart"),y=100,z=x.clientWidth-100-20-15,A=x.clientHeight-20,B=preact,C=B.h,h=B.render,D=.4,E={lat:0,lon:0,elevation:0,modelElevation:0,tempRange:[0,0],pressureRange:[0,0],data:{}},F=[],G=a.temp.convertNumber,H=a.wind.convertNumber,I=a.pressure.convertNumber,J=function(b){return i("ft"===a.cloudtop.metric?3.28084*b:b)},K=function(){var a=Math.pow;if(!j){j=d3.scaleLinear().range([0,z]),l=d3.scaleLinear().range([0,y]),k=d3.scaleLog().range([A,0]),m=d3.scaleLinear().range([0,z]),o=d3.scaleLinear().range([A,0]),n=d3.scaleLinear().range([0,y]),p=d3.axisBottom(m).ticks(5,"-d"),r=d3.axisRight(o).ticks(10,"d"),q=d3.axisBottom(n).ticks(4,"d"),s=d3.line().x(function(a){return j(a.temp)+D*(A-k(a.pressure))}).y(function(a){return k(a.pressure)}),t=d3.line().x(function(a){return j(a.dewpoint)+D*(A-k(a.pressure))}).y(function(a){return k(a.pressure)}),u=d3.line().x(function(a){return l(e.wind2obj([a.wind_u,a.wind_v]).wind)}).y(function(a){return k(a.pressure)});var b=function(a){var b=a.temp;if(0==D)return null;var c=j(b+273);return C("line",{x1:c,y1:A,x2:z,y2:A-(z-c)/D,stroke:"darkred","stroke-width":"0.2"})},c=function(b){for(var c=Math.log,d=b.q,e=[],f=A/6,g=A;g>-f;g-=f){var h=k.invert(g),i=a(c(h*d/(d+622)/6.11),-1),l=273+a(17.269/237.3*(i-1/17.269),-1);e.push({t:l,p:h})}var m=d3.line().x(function(a){return j(a.t)+D*(A-k(a.p))}).y(function(a){return k(a.p)});return C("path",{fill:"none",stroke:"blue","stroke-width":"0.3","stroke-dasharray":"2",d:m(e)})},d=function(b){for(var c=b.temp,d=[],e=k.domain()[0],f=A/15,g=A;g>-f;g-=f){var h=k.invert(g),i=(c+273)*a(e/h,-287/1030);d.push({t:i,p:h})}var l=d3.line().x(function(a){return j(a.t)+D*(A-k(a.p))}).y(function(a){return k(a.p)});return C("path",{fill:"none",stroke:"green","stroke-width":"0.3",d:l(d)})},f=function(a){for(var b=Math.exp,c=a.temp,d=[],e=k.domain()[0],f=1030,g=25e5,h=287,i=c+273,l=e,m=A/15,n=A;n>-m;n-=m){var o=k.invert(n),p=g/461*(1/273-1/i),q=6.11*b(p)*(.622/o),r=g*q/(h*i),s=h*i/(f*o)*(1+r),u=1+r*(1555000/(f*i));i-=s/u*(l-o),l=o,d.push({t:i,p:o})}var v=d3.line().x(function(a){return j(a.t)+D*(A-k(a.p))}).y(function(a){return k(a.p)});return C("path",{fill:"none",stroke:"green","stroke-width":"0.3","stroke-dasharray":"3 5",d:v(d)})},g=function(a){var b=a.wind_u,c=a.wind_v,d=a.y,f=e.wind2obj([b,c]);return C("g",null,1<f.wind?C("g",{transform:"translate(0,".concat(d,") rotate(").concat(f.dir,")"),stroke:"black",fill:"none"},C("line",{y2:"-30"}),C("polyline",{points:"-5,-10 0,0 5,-10","stroke-linejoin":"round"})):C("g",{transform:"translate(0,".concat(d,")"),stroke:"black",fill:"none"},C("circle",{r:"6"}),C("circle",{r:"1"})))};v=function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=a.data;return C("svg",{id:"sounding"},C("defs",null,C("clipPath",{id:"clip-chart"},C("rect",{x:"0",y:"0",width:z,height:A+20}))),e?C("g",null,C("g",{class:"wind"},C("g",{class:"chart",transform:"translate(".concat(z+30,",0)")},C("g",{class:"x axis",transform:"translate(0,".concat(A,")"),ref:function b(a){return d3.select(a).call(q)}}),C("line",{y1:A,y2:"0",stroke:"black","stroke-width":"0.2","stroke-dasharray":"3"}),C("line",{y1:A,x1:l(15/3.6),y2:"0",x2:l(15/3.6),stroke:"black","stroke-width":"0.2","stroke-dasharray":"3"}),C("rect",{x:y/2,width:y/2,height:A,fill:"red",opacity:"0.1"}),C("g",{class:"chartArea","clip-path":"url(#clip-chart)"},C("path",{class:"temperature chart",fill:"none",stroke:"purple","stroke-linejoin":"round","stroke-linecap":"round","stroke-width":"1.5",d:u(e)}),C("g",{transform:"translate(".concat(y/2,",0)")},e.map(function(a){return C(g,{wind_u:a.wind_u,wind_v:a.wind_v,y:k(a.pressure)})}))))),C("g",{class:"chart",transform:"translate(10,0)"},C("g",{class:"axis"},C("g",{class:"x axis",transform:"translate(0,".concat(A,")"),ref:function b(a){return d3.select(a).call(p)}}),C("g",{class:"y axis",y:A+16,ref:function b(a){return d3.select(a).call(r)}})),C("g",{class:"chartArea","clip-path":"url(#clip-chart)","stroke-linejoin":"round","stroke-linecap":"round"},C("text",{class:"y label",opacity:"0.75",x:"0",y:"-4"}),C("rect",{class:"overlay",width:z,height:A,opacity:"0"}),C("path",{class:"temperature chart",fill:"none",stroke:"red","stroke-width":"1.5",d:s(e)}),C("path",{class:"dewpoint chart",fill:"none",stroke:"steelblue","stroke-width":"1.5",d:t(e)}),[-70,-60,-50,-40,-30,-20,-10,0,10,20].map(function(a){return C(b,{temp:a})}),[-20,-10,0,5,10,15,20,25,30,40,50,60,70,80].map(function(a){return C(d,{temp:a})}),[-20,-10,0,5,10,15,20,25,30,35].map(function(a){return C(f,{temp:a})}),[.01,.1,.5,1,2,5,8,12,16,20].map(function(a){return C(c,{q:a})})))):C("text",{x:"50%",y:"50%","text-anchor":"middle"},"No Data"))},w=h(C(v,{display:"block"}),x,w)}},M=function(){if(F=null,E.data){var a,c,e=b.get("timestamp"),f=Object.getOwnPropertyNames(E.data).sort(function(c,a){return+c<+a?-1:1}),g=f.findIndex(function(a){return a>=e});-1<g&&(0==g?a=c=f[0]:(a=f[g-1],c=f[g]),F=d.interpolateArray(E.data[a],E.data[c],c==a?0:(e-a)/(c-a)))}w=h(C(v,{data:F,display:"block"}),x,w)};return{load:function s(a,c,e,h){E.lat=a,E.lon=c;var j={};for(var t in h.data)h.data[t].forEach(function(a){return j[a.origTs]=a});var k=e.data.hours,l=e.header.elevation,n=e.header.modelElevation,o=new Set,p=new Set;for(var d in e.data){var u=d.match(/([^-]+)-(.+)h$/);null!==u&&(o.add(u[1]),p.add(+u[2]))}var q=[-1].concat(_toConsumableArray(Array.from(p).filter(function(a){return 300<a}).sort(function(c,a){return+c<+a?1:-1}))),r={};k.forEach(function(a,b){r[a]=[],q.forEach(function(c){var d=0>c?"surface":"".concat(c,"h"),f=g(e,"gh",d,b);if(f>=n){var h=0>c?i(j[a].pressure/100):c;r[a].push({temp:g(e,"temp",d,b),dewpoint:g(e,"dewpoint",d,b),gh:g(e,"gh",d,b),wind_u:g(e,"wind_u",d,b),wind_v:g(e,"wind_v",d,b),pressure:h,forecast:j[a]})}})}),E.data=r,E.elevation=l,E.modelElevation=n,f(E),b.on("timestamp",M),M()},init:K}}),W.define("windy-plugin-sounding/soundingUtils",[],function(){function a(a,b,c){var d={},e=Object.getOwnPropertyNames(a);return e.forEach(function(e){d[e]=(1-c)*a[e]+c*b[e]}),d}function b(a,b){var c=_slicedToArray(a,2),e=_slicedToArray(c[0],2),f=e[0],g=e[1],h=_slicedToArray(c[1],2),i=h[0],j=h[1],k=_slicedToArray(b,2),l=_slicedToArray(k[0],2),m=l[0],n=l[1],o=_slicedToArray(k[1],2),p=o[0],q=o[1];if(0==i-f&&0==j-g||0==p-m&&0==q-n)return null;var r=(j-g)*(p-m)-(i-f)*(q-n);if(!r)return null;var d=((i-f)*(n-g)+(j-g)*(f-m))/r;if(0>d||1<d)return null;var t=m+d*(p-m),u=n+d*(q-n),v=i-f?(t-f)/(i-f):(u-g)/(j-g);return 0>v||1<v?null:[t,u]}return{validateData:function(a){for(var b=function(b){var d=Object.keys(a[b]);d.find(function(c){return null==a[b][c]})?a.splice(b,1):++b,c=b},c=0;c<a.length;)b(c)},interpolateArray:function(b,c,d){var e=[];return b.forEach(function(b,f){var g=b.pressure,h=0==f?c[0]:c.find(function(a){return a.pressure==g});h&&e.push(a(b,h,d))}),e},interpolatePoint:a,intersection:b,dataIntersection:function(a,c,d){for(var e,f=0;f<c.length-1;++f)if(e=b(a,[d(c[f]),d(c[f+1])]),e)return e;return null}}}
